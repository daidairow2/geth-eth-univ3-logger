name: logger
on:
  schedule: [{ cron: "*/15 * * * *" }]  # 15分ごと（UTC）
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: logger
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: npm ci || npm i

      - name: Write .env for this run
        run: |
          cat > .env << 'EOF'
          # Uniswap v3 Base WETH/USDC 0.05% プール（既定）
          ETH_USDC_V3_POOL=0xd0b53d9277642d899df5c87a3966a349a798f224
          # The Graph Gateway の API キー（必須）
          THEGRAPH_API_KEY=${{ secrets.THEGRAPH_API_KEY }}
          # Uniswap v3 Base のサブグラフID（既定のままでOK）
          THEGRAPH_SUBGRAPH_ID=FUbEPQw1oMghy39fwWBFY5fE6MXPXZQtjncQy2cXdrNS
          EOF

      - name: Run logger once
        run: npm run once

      - name: Ensure data dir & placeholder
        run: |
          mkdir -p data
          [ -f data/.gitkeep ] || echo placeholder > data/.gitkeep

      - name: Commit CSV
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/ethusdc_stats.csv data/.gitkeep || true
          git commit -m "update $(date -u +'%Y-%m-%dT%H:%M:%SZ')" || echo "no changes"
          git push || true
